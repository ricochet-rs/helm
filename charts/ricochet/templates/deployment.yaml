apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "ricochet.fullname" . }}
  labels:
    {{- include "ricochet.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: {{ .Values.strategy.type }}
    {{- if eq .Values.strategy.type "RollingUpdate" }}
    rollingUpdate:
      maxSurge: {{ .Values.strategy.rollingUpdate.maxSurge }}
      maxUnavailable: {{ .Values.strategy.rollingUpdate.maxUnavailable }}
    {{- end }}
  selector:
    matchLabels:
      {{- include "ricochet.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- if ne (len .Values.config) 0 }}
        checksum/config: {{ printf "%s-%s-%s-%s-%s" (toYaml .Values.config | sha256sum) (toYaml .Values.apps.deployment.persistence | sha256sum) (toYaml .Values.apps.deployment.imagePullPolicy | sha256sum) (toYaml .Values.apps.deployment.imagePullSecrets | sha256sum) (toYaml .Values.execEnv | sha256sum) }}
        {{- end }}
        {{- if .Values.config.secrets }}
        checksum/secret-config: {{ toYaml .Values.config.secrets | sha256sum }}
        {{- end }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "ricochet.selectorLabels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "ricochet.serviceAccountName" . }}
      {{- if .Values.podSecurityContext }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      {{- end }}
      {{- if or .Values.initContainers .Values.persistence.home.enabled (ne (len .Values.config) 0) }}
      initContainers:
        {{- if .Values.persistence.home.enabled }}
        - name: fix-permissions
          image: busybox:1.37
          command: ['sh', '-c']
          args:
            - |
              mkdir -p {{ .Values.persistence.home.mountPath }}/content
              chown -R 1000:1000 {{ .Values.persistence.home.mountPath }}
          securityContext:
            runAsUser: 0
            runAsNonRoot: false
          volumeMounts:
            {{- if .Values.persistence.home.enabled }}
            - name: home-storage
              mountPath: {{ .Values.persistence.home.mountPath }}
            {{- end }}
        {{- end }}
        {{- if ne (len .Values.config) 0 }}
        - name: merge-config
          image: busybox:1.37
          command: ['sh', '-c']
          args:
            - |
              # Create config directory
              mkdir -p /var/lib/ricochet/data

              # Start with base config
              if [ -f /config/ricochet-config.toml ]; then
                cp /config/ricochet-config.toml /var/lib/ricochet/data/ricochet-config.toml
              else
                touch /var/lib/ricochet/data/ricochet-config.toml
              fi

              {{- if .Values.config.secrets }}
              # Process secret references
              {{- range $section, $secretRefs := .Values.config.secrets }}
              {{- range $key, $ref := $secretRefs }}
              {{- if kindOf $ref | eq "map" }}
              {{- if $ref.secretName }}

              # Fetch secret value for {{ $section }}.{{ $key }}
              SECRET_VALUE=$(cat /secrets/{{ $ref.secretName }}/{{ $ref.key | default $key }} 2>/dev/null || echo "")
              if [ -n "$SECRET_VALUE" ]; then
                # Check if section exists
                ESCAPED_SECTION=$(echo "{{ $section }}" | sed 's/\./\\./g')
                if grep -q "^\[$ESCAPED_SECTION\]" /var/lib/ricochet/data/ricochet-config.toml; then
                  # Section exists - append key after the section header
                  sed -i "/^\[$ESCAPED_SECTION\]/a {{ $key }} = \"$SECRET_VALUE\"" /var/lib/ricochet/data/ricochet-config.toml
                else
                  # Section doesn't exist - create it
                  echo "" >> /var/lib/ricochet/data/ricochet-config.toml
                  echo "[{{ $section }}]" >> /var/lib/ricochet/data/ricochet-config.toml
                  echo '{{ $key }} = "'$SECRET_VALUE'"' >> /var/lib/ricochet/data/ricochet-config.toml
                fi
              fi
              {{- end }}
              {{- else }}
              # Simple secret reference for {{ $section }}.{{ $key }}
              SECRET_VALUE=$(cat /secrets/{{ $ref }}/{{ $key }} 2>/dev/null || echo "")
              if [ -n "$SECRET_VALUE" ]; then
                # Check if section exists
                ESCAPED_SECTION=$(echo "{{ $section }}" | sed 's/\./\\./g')
                if grep -q "^\[$ESCAPED_SECTION\]" /var/lib/ricochet/data/ricochet-config.toml; then
                  # Section exists - append key after the section header
                  sed -i "/^\[$ESCAPED_SECTION\]/a {{ $key }} = \"$SECRET_VALUE\"" /var/lib/ricochet/data/ricochet-config.toml
                else
                  # Section doesn't exist - create it
                  echo "" >> /var/lib/ricochet/data/ricochet-config.toml
                  echo "[{{ $section }}]" >> /var/lib/ricochet/data/ricochet-config.toml
                  echo '{{ $key }} = "'$SECRET_VALUE'"' >> /var/lib/ricochet/data/ricochet-config.toml
                fi
              fi
              {{- end }}
              {{- end }}
              {{- end }}
              {{- end }}

              # Set proper permissions
              chown -R 1000:1000 /var/lib/ricochet/data
          securityContext:
            runAsUser: 0
            runAsNonRoot: false
          volumeMounts:
            {{- if ne (len .Values.config) 0 }}
            - name: config
              mountPath: /config
            {{- end }}
            {{- if .Values.config.secrets }}
            {{- $uniqueSecrets := dict }}
            {{- range $section, $secretRefs := .Values.config.secrets }}
            {{- range $key, $ref := $secretRefs }}
            {{- if kindOf $ref | eq "map" }}
            {{- if $ref.secretName }}
            {{- $_ := set $uniqueSecrets $ref.secretName true }}
            {{- end }}
            {{- else }}
            {{- $_ := set $uniqueSecrets $ref true }}
            {{- end }}
            {{- end }}
            {{- end }}
            {{- range $secretName, $_ := $uniqueSecrets }}
            - name: secret-{{ $secretName }}
              mountPath: /secrets/{{ $secretName }}
            {{- end }}
            {{- end }}
            {{- if .Values.persistence.home.enabled }}
            - name: home-storage
              mountPath: {{ .Values.persistence.home.mountPath }}
            {{- else }}
            - name: config-merged
              mountPath: /var/lib/ricochet/data
            {{- end }}
        {{- end }}
        {{- with .Values.initContainers }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- end }}
      containers:
        - name: {{ .Chart.Name }}
          {{- if .Values.securityContext }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          {{- end }}
          image: {{ include "ricochet.image" . }}
          imagePullPolicy: {{ include "ricochet.imagePullPolicy" . }}
          ports:
            - name: http
              containerPort: {{ .Values.service.targetPort }}
              protocol: {{ .Values.service.protocol }}
          {{- with .Values.env }}
          env:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.envFrom }}
          envFrom:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- if .Values.livenessProbe }}
          livenessProbe:
            {{- toYaml .Values.livenessProbe | nindent 12 }}
          {{- end }}
          {{- if .Values.readinessProbe }}
          readinessProbe:
            {{- toYaml .Values.readinessProbe | nindent 12 }}
          {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          volumeMounts:
            {{- if .Values.persistence.home.enabled }}
            - name: home-storage
              mountPath: {{ .Values.persistence.home.mountPath }}
            {{- else if ne (len .Values.config) 0 }}
            - name: config-merged
              mountPath: /var/lib/ricochet/data
            {{- end }}
            {{- if .Values.execEnv.config }}
            - name: exec-env-config
              mountPath: /var/lib/ricochet/data/ricochet-exec-env.toml
              subPath: ricochet-exec-env.toml
              readOnly: true
            {{- end }}
            {{- if .Values.apps.deployment.persistence.content.enabled }}
            - name: apps-content-storage
              mountPath: {{ .Values.apps.deployment.persistence.content.mountPath }}
            {{- end }}
            {{- if .Values.apps.deployment.persistence.cache.enabled }}
            - name: apps-cache-storage
              mountPath: {{ .Values.apps.deployment.persistence.cache.mountPath }}
            {{- end }}
            {{- with .Values.extraVolumeMounts }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
        {{- with .Values.sidecarContainers }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- if .Values.jaeger.enabled }}
        - name: jaeger
          image: {{ .Values.jaeger.image }}
          env:
            - name: COLLECTOR_OTLP_ENABLED
              value: "true"
          ports:
            - name: otlp-grpc
              containerPort: 4317
              protocol: TCP
            - name: jaeger-ui
              containerPort: 16686
              protocol: TCP
          {{- with .Values.jaeger.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
        {{- end }}
      volumes:
        {{- if .Values.persistence.home.enabled }}
        - name: home-storage
          persistentVolumeClaim:
            claimName: {{ .Values.persistence.home.existingClaim | default (printf "%s-home" (include "ricochet.fullname" .)) }}
        {{- end }}
        {{- if ne (len .Values.config) 0 }}
        - name: config
          configMap:
            name: {{ .Values.existingConfigMap | default (printf "%s-config" (include "ricochet.fullname" .)) }}
        {{- end }}
        {{- if .Values.config.secrets }}
        {{- $uniqueSecrets := dict }}
        {{- range $section, $secretRefs := .Values.config.secrets }}
        {{- range $key, $ref := $secretRefs }}
        {{- if kindOf $ref | eq "map" }}
        {{- if $ref.secretName }}
        {{- $_ := set $uniqueSecrets $ref.secretName true }}
        {{- end }}
        {{- else }}
        {{- $_ := set $uniqueSecrets $ref true }}
        {{- end }}
        {{- end }}
        {{- end }}
        {{- range $secretName, $_ := $uniqueSecrets }}
        - name: secret-{{ $secretName }}
          secret:
            secretName: {{ $secretName }}
        {{- end }}
        {{- end }}
        {{- if and (ne (len .Values.config) 0) (not .Values.persistence.home.enabled) }}
        - name: config-merged
          emptyDir: {}
        {{- end }}
        {{- if .Values.execEnv.config }}
        - name: exec-env-config
          configMap:
            name: {{ include "ricochet.fullname" . }}-exec-env
        {{- end }}
        {{- if .Values.apps.deployment.persistence.content.enabled }}
        - name: apps-content-storage
          persistentVolumeClaim:
            claimName: {{ .Values.apps.deployment.persistence.content.existingClaim | default (printf "%s-apps-content" (include "ricochet.fullname" .)) }}
        {{- end }}
        {{- if .Values.apps.deployment.persistence.cache.enabled }}
        - name: apps-cache-storage
          persistentVolumeClaim:
            claimName: {{ .Values.apps.deployment.persistence.cache.existingClaim | default (printf "%s-apps-cache" (include "ricochet.fullname" .)) }}
        {{- end }}
        {{- with .Values.extraVolumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
