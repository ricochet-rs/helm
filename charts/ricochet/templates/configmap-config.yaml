{{- if or (ne (len .Values.config) 0) .Values.existingConfigMap -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ricochet.fullname" . }}-config
  labels:
    {{- include "ricochet.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
data:
  ricochet-config.toml: |
{{- if .Values.config.raw }}
    {{- .Values.config.raw | nindent 4 }}
{{- else }}
    # Ricochet Configuration
    # Generated by Helm

    {{- range $section, $values := .Values.config }}
    {{- if and (ne $section "raw") (ne $section "custom") (ne $section "secrets") (ne $section "existingConfigMap") (ne $section "launcher_k8s") $values }}

    [{{ $section }}]
    {{- range $key, $value := $values }}
    {{- if eq (kindOf $value) "string" }}
    {{ $key }} = {{ $value | quote }}
    {{- else if eq (kindOf $value) "bool" }}
    {{ $key }} = {{ $value }}
    {{- else if or (eq (kindOf $value) "float64") (eq (kindOf $value) "int64") (eq (kindOf $value) "int") }}
    {{ $key }} = {{ $value }}
    {{- else if eq (kindOf $value) "slice" }}
    {{ $key }} = [{{ range $i, $v := $value }}{{ if $i }}, {{ end }}{{ $v | quote }}{{ end }}]
    {{- else if eq (kindOf $value) "map" }}
    # Complex nested value - using inline table
    {{ $key }} = { {{ range $k, $v := $value }}{{ $k }} = {{ $v | quote }}, {{ end }}}
    {{- end }}
    {{- end }}
    {{- end }}
    {{- end }}

    {{- if or .Values.config.launcher_k8s .Values.launcher.deployment.persistence.content.enabled .Values.launcher.deployment.persistence.cache.enabled .Values.launcher.deployment.imagePullPolicy .Values.launcher.deployment.imagePullSecrets .Values.launcher.deployment.strategy }}
    # Launcher Kubernetes configuration
    [launcher_k8s]
    {{- if .Values.config.launcher_k8s }}
    {{- range $key, $value := .Values.config.launcher_k8s }}
    {{- if eq (kindOf $value) "string" }}
    {{ $key }} = {{ $value | quote }}
    {{- else if eq (kindOf $value) "bool" }}
    {{ $key }} = {{ $value }}
    {{- else if or (eq (kindOf $value) "float64") (eq (kindOf $value) "int64") (eq (kindOf $value) "int") }}
    {{ $key }} = {{ $value }}
    {{- else if eq (kindOf $value) "slice" }}
    {{ $key }} = [{{ range $i, $v := $value }}{{ if $i }}, {{ end }}{{ $v | quote }}{{ end }}]
    {{- end }}
    {{- end }}
    {{- end }}
    {{- if .Values.launcher.deployment.strategy }}
    {{- if .Values.launcher.deployment.strategy.type }}
    strategy_type = {{ .Values.launcher.deployment.strategy.type | quote }}
    {{- end }}
    {{- if and (eq .Values.launcher.deployment.strategy.type "RollingUpdate") .Values.launcher.deployment.strategy.rollingUpdate }}
    {{- if .Values.launcher.deployment.strategy.rollingUpdate.maxSurge }}
    strategy_max_surge = {{ .Values.launcher.deployment.strategy.rollingUpdate.maxSurge }}
    {{- end }}
    {{- if .Values.launcher.deployment.strategy.rollingUpdate.maxUnavailable }}
    strategy_max_unavailable = {{ .Values.launcher.deployment.strategy.rollingUpdate.maxUnavailable }}
    {{- end }}
    {{- end }}
    {{- end }}
    {{- if .Values.launcher.deployment.imagePullPolicy }}
    image_pull_policy = {{ .Values.launcher.deployment.imagePullPolicy | quote }}
    {{- end }}
    {{- if .Values.launcher.deployment.imagePullSecrets }}
    image_pull_secrets = [{{ range $i, $secret := .Values.launcher.deployment.imagePullSecrets }}{{ if $i }}, {{ end }}{{ $secret.name | quote }}{{ end }}]
    {{- end }}
    {{- if .Values.launcher.deployment.persistence.content.enabled }}
    pvc_content_name = {{ .Values.launcher.deployment.persistence.content.existingClaim | default (printf "%s-launcher-content" (include "ricochet.fullname" .)) | quote }}
    {{- end }}
    {{- if .Values.launcher.deployment.persistence.cache.enabled }}
    pvc_cache_name = {{ .Values.launcher.deployment.persistence.cache.existingClaim | default (printf "%s-launcher-cache" (include "ricochet.fullname" .)) | quote }}
    {{- end }}
    {{- end }}

    {{- with .Values.config.custom }}
    # Custom configuration
    {{- . | nindent 4 }}
    {{- end }}
{{- end }}
{{- end }}
