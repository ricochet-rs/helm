suite: persistent volume claims
templates:
  - pvc-home.yaml
tests:
  # Home PVC tests
  - it: should create home PVC when enabled
    template: pvc-home.yaml
    set:
      persistence.home.enabled: true
      persistence.home.size: 25Gi
      persistence.home.accessMode: ReadWriteOnce
    asserts:
      - isKind:
          of: PersistentVolumeClaim
      - equal:
          path: metadata.name
          value: RELEASE-NAME-ricochet-home
      - equal:
          path: spec.resources.requests.storage
          value: 25Gi
      - equal:
          path: spec.accessModes[0]
          value: ReadWriteOnce
      - matchRegex:
          path: metadata.labels["app.kubernetes.io/component"]
          pattern: home

  - it: should not create home PVC when disabled
    template: pvc-home.yaml
    set:
      persistence.home.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create home PVC when existingClaim is specified
    template: pvc-home.yaml
    set:
      persistence.home.enabled: true
      persistence.home.existingClaim: existing-home-pvc
    asserts:
      - hasDocuments:
          count: 0

  - it: should set home storageClass when specified
    template: pvc-home.yaml
    set:
      persistence.home.enabled: true
      persistence.home.storageClass: fast-ssd
      persistence.home.size: 25Gi
    asserts:
      - equal:
          path: spec.storageClassName
          value: fast-ssd

  - it: should use default storageClass when dash is specified for home
    template: pvc-home.yaml
    set:
      persistence.home.enabled: true
      persistence.home.storageClass: '-'
      persistence.home.size: 25Gi
    asserts:
      - equal:
          path: spec.storageClassName
          value: ''

  - it: should add annotations to home PVC when specified
    template: pvc-home.yaml
    set:
      persistence.home.enabled: true
      persistence.home.size: 25Gi
      persistence.home.annotations:
        volume.beta.kubernetes.io/storage-class: ssd
        backup.velero.io/backup-volumes: home-storage
    asserts:
      - equal:
          path: metadata.annotations["volume.beta.kubernetes.io/storage-class"]
          value: ssd
      - equal:
          path: metadata.annotations["backup.velero.io/backup-volumes"]
          value: home-storage
